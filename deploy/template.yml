AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Parameters:
  URI:
    Type: String
    Description: The URI used to name resources [projectName-env-gitUsername-subdomain]
  env:
    Type: String
    Default: dev
    Description: Enter the environment
    AllowedValues:
      - dev
      - production
      - staging
  domain:
    Type: String
    Description: The domain name of the project
  AcmArn:
    Type: String
    Description: The ARN of the ssl certificate genereted on ACM
  ApiUrl:
    Type: String
    Description: The enpoint to connect with the api distribution
  ClusterName:
    Description: >-
      Name of the cluster as it appears in Atlas. Once the cluster is created,
      its name cannot be changed.
    Type: String
    Default: Cluster-1
  ClusterRegion:
    Default: us-east-1
    Description: The AWS Region where the Atlas DB Cluster will run.
    Type: String
    AllowedValues:
      - us-east-1
      - us-east-2
      - ca-central-1
      - us-west-1
      - us-west-2
      - sa-east-1
      - ap-south-1
      - ap-east-2
      - ap-southeast-1
      - ap-southeast-2
      - ap-northeast-1
      - ap-northeast-2
      - eu-central-1
      - eu-west-1
      - eu-north-1
      - eu-west-1
      - eu-west-2
      - eu-west-3
      - eu-south-1
      - me-south-1
      - af-south-1
  ClusterMongoDBMajorVersion:
    Description: The version of MongoDB
    Type: String
    Default: '5.0'
    AllowedValues:
      - '3.6'
      - '4.0'
      - '4.2'
      - '4.4'
      - '5.0'
  AwsSecretName:
    Type: String
    Description: Name of the secret containing atlas PrivateKey, PubilcKey, OrgId and ProjectId
  startSeeder:
    Type: String
    Default: 'false'
    Description: 'Boolean value, if true then codedeploy runs seeder'
  DatabaseName:
    Description: Name of the DB
    Type: String
  HostedZoneId:
    Description: Hosted zone Id on route 53
    Type: String
  DatabaseSrv:
    Description: Tmp SRV address used to connect to a serverless mongodb atlas InstanceRole
    Type: String
Mappings:
  Environments:
    dev:
      RetentionPeriod: 1
      S3TempDays: 1
      InstanceType: t2.micro
      VpcCIDRBlock: 10.0.0.0/16
      PublicSubnetCIDR: 10.0.0.0/24
      ClusterInstanceSize: M10
    staging:
      RetentionPeriod: 1
      S3TempDays: 7
      InstanceType: t2.micro
      VpcCIDRBlock: 10.1.0.0/16
      PublicSubnetCIDR: 10.1.0.0/24
      ClusterInstanceSize: M10
    production:
      RetentionPeriod: 35
      S3TempDays: 7
      InstanceType: t2.micro
      VpcCIDRBlock: 10.2.0.0/16
      PublicSubnetCIDR: 10.2.0.0/24
      ClusterInstanceSize: M10
  RegionMap:
    us-east-1:
      HVM64: ami-0ed9277fb7eb570c9
    us-east-2:
      HVM64: ami-002068ed284fb165b
    us-west-1:
      HVM64: ami-03af6a70ccd8cb578
    us-west-2:
      HVM64: ami-00f7e5c52c0f43726
    ca-central-1:
      HVM64: ami-0bae7412735610274
    eu-central-1:
      HVM64: ami-05d34d340fb1d89e5
    eu-south-1:
      HVM64: ami-08d64ae428dd09b2a
    eu-west-1:
      HVM64: ami-04dd4500af104442f
    eu-west-2:
      HVM64: ami-0d37e07bd4ff37148
Resources:
  ApiCachePolicy:
    Type: 'AWS::CloudFront::CachePolicy'
    Properties:
      CachePolicyConfig:
        DefaultTTL: 0
        MaxTTL: 0
        MinTTL: 0
        Name: !Sub '${URI}-cache-policy'
        ParametersInCacheKeyAndForwardedToOrigin:
          CookiesConfig:
            CookieBehavior: none
          EnableAcceptEncodingGzip: 'false'
          HeadersConfig:
            HeaderBehavior: none
          QueryStringsConfig:
            QueryStringBehavior: none
  ApiDistribution:
    Type: 'AWS::CloudFront::Distribution'
    Properties:
      DistributionConfig:
        HttpVersion: http2
        Enabled: 'true'
        Origins:
          - DomainName: !GetAtt
              - ApiEC2
              - PublicDnsName
            Id: !Ref ApiEC2
            CustomOriginConfig:
              HTTPPort: 80
              OriginProtocolPolicy: http-only
        Aliases:
          - !Ref ApiUrl
          - 'api.progotan.com'
        ViewerCertificate:
          AcmCertificateArn: !Ref AcmArn
          SslSupportMethod: sni-only
          MinimumProtocolVersion: TLSv1.2_2021
        DefaultCacheBehavior:
          AllowedMethods:
            - DELETE
            - GET
            - HEAD
            - OPTIONS
            - PATCH
            - POST
            - PUT
          TargetOriginId: !Ref ApiEC2
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: 216adef6-5c7f-47e4-b989-5492eafa07d3
          ViewerProtocolPolicy: allow-all
          Compress: true
  ApiSecurityGroup:
    Type: 'AWS::EC2::SecurityGroup'
    Properties:
      GroupName: !Sub '${URI}-security-group'
      GroupDescription: Allow HTTPS access from
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '80'
          ToPort: '80'
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          CidrIp: 0.0.0.0/0
  ApiEC2:
    Type: 'AWS::EC2::Instance'
    DependsOn:
      - AtlasNetworkPeering
      - AtlasDatabaseUser
    Metadata:
      'AWS::CloudFormation::Init':
        config:
          packages:
            yum:
              ruby: []
              awslogs: []
              git: []
              jq: []
          files:
            /home/ec2-user/install:
              source: !Sub 'https://aws-codedeploy-${AWS::Region}.s3.amazonaws.com/latest/install'
              mode: '000755'
            /home/ec2-user/DBUrl:
              content: !Ref DatabaseSrv
            /home/ec2-user/SecretName:
              content: !Ref AwsSecretName
            /home/ec2-user/DatabaseName:
              content: !Ref DatabaseName
            /home/ec2-user/env:
              content: !Ref env
            /home/ec2-user/startSeeder:
              content: !Ref startSeeder
            /home/ec2-user/PublicRouteTableId:
              content: !Ref PublicRouteTable
            /etc/yum.repos.d/mongodb-org-5.0.repo:
              content: |-
                [mongodb-org-5.0]

                name=MongoDB Repository

                baseurl=https://repo.mongodb.org/yum/amazon/2/mongodb-org/5.0/x86_64/

                gpgcheck=1

                enabled=1

                gpgkey=https://www.mongodb.org/static/pgp/server-5.0.asc
            /etc/awslogs/awscli.conf:
              content: !Sub |-
                [plugins]
                cwlogs = cwlogs
                [default]
                region = ${AWS::Region}
            /etc/awslogs/awslogs.conf:
              content: !Sub |-
                [general]
                state_file = /var/awslogs/state/agent-state
                use_gzip_http_content_encoding = true
                queue_size = 10

                [logger]
                file = /home/ec2-user/app/app.out.log
                log_group_name = ${URI}-ec2-logs
                initial_position = start_of_file
                datetime_format = %Y-%m-%d %H:%M:%S
                log_stream_name = logs
                buffer_duration = 5000

                [errors]
                file = /home/ec2-user/app/app.err.log
                log_group_name = ${URI}-ec2-logs
                initial_position = start_of_file
                datetime_format = %Y-%m-%d %H:%M:%S
                log_stream_name = errors
                buffer_duration = 5000

                [system]
                file = /var/log/messages
                log_group_name = ${URI}-ec2-logs
                initial_position = start_of_file
                datetime_format = %Y-%m-%d %H:%M:%S
                log_stream_name = system
                buffer_duration = 5000

                [deployment]
                file = /opt/codedeploy-agent/deployment-root/deployment-logs/codedeploy-agent-deployments.log 
                log_group_name = ${URI}-ec2-logs
                initial_position = start_of_file
                datetime_format = %Y-%m-%d %H:%M:%S
                log_stream_name = deployment
                buffer_duration = 5000
            /etc/nginx/conf.d/api.conf:
              content: !Sub |-
                server {
                    listen 80;
                    server_name ${ApiUrl};
                    
                    location / {
                        proxy_pass http://127.0.0.1:3000;
                        proxy_set_header Host $host;
                        proxy_set_header X-Real-IP $remote_addr;
                        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                        proxy_set_header X-Forwarded-Proto $scheme;
                    }
                }
          commands:
            00-install-agent:
              command: ./install auto
              cwd: /home/ec2-user/
            01-cfn-signal:
              command: !Sub '/opt/aws/bin/cfn-signal -e 0 --stack ${AWS::StackName} --resource ApiEC2 --region ${AWS::Region}'
            02-install-mongo:
              cwd: /home/ec2-user/
              command: sudo yum install -y mongodb-org
            03-start-cloudwatch-agent:
              command: mkdir /var/awslogs && mkdir /var/awslogs/state && sudo systemctl start awslogsd
            04-set-agent-as-service:
              command: sudo systemctl enable awslogsd.service
            05-install-nginx:
              command: yes y | sudo amazon-linux-extras install nginx1 && sudo systemctl start nginx
    CreationPolicy:
      ResourceSignal:
        Count: '1'
        Timeout: PT5M
    Properties:
      IamInstanceProfile: !Ref InstanceRoleInstanceProfile
      InstanceType: !FindInMap
        - Environments
        - !Ref env
        - InstanceType
      ImageId: !FindInMap
        - RegionMap
        - !Ref 'AWS::Region'
        - HVM64
      UserData: !Base64
        'Fn::Join':
          - ''
          - - |
              #!/bin/bash
            - |
              yum -y update
            - |
              yum -y install cfn-bootstrap
            - |
              curl -sL https://rpm.nodesource.com/setup_lts.x | bash -
            - |
              yum install nodejs -y
            - /opt/aws/bin/cfn-init -v
            - ' --stack '
            - !Ref 'AWS::StackName'
            - ' --resource ApiEC2'
            - ' --region '
            - !Ref 'AWS::Region'
            - |+

      KeyName: !Sub '${URI}-keys'
      Tags:
        - Key: DeploymentTag
          Value: !Sub '${URI}'
      SubnetId: !Ref PublicSubnet
      SecurityGroupIds:
        - !Ref ApiSecurityGroup
  LogsAPI:
    Type: 'AWS::Logs::LogGroup'
    Properties:
      LogGroupName: !Sub '${URI}-ec2-logs'
      RetentionInDays: 14
  CodedeployApplicationApi:
    Type: 'AWS::CodeDeploy::Application'
    Properties:
      ApplicationName: !Sub '${URI}-codedeploy-application'
      ComputePlatform: Server
  CodeDeployTrustRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Sid: '1'
            Effect: Allow
            Principal:
              Service:
                - codedeploy.amazonaws.com
            Action: 'sts:AssumeRole'
      Path: /
  CodedeployGroup:
    Type: 'AWS::CodeDeploy::DeploymentGroup'
    Properties:
      ApplicationName: !Sub '${URI}-codedeploy-application'
      DeploymentGroupName: !Sub '${URI}-deployment-group'
      ServiceRoleArn: !GetAtt
        - CodeDeployTrustRole
        - Arn
      Ec2TagFilters:
        - Key: DeploymentTag
          Value: !Sub '${URI}'
          Type: KEY_AND_VALUE
      Deployment:
        Revision:
          RevisionType: S3
          S3Location:
            BundleType: zip
            Bucket: !Sub '${URI}'
            Key: api
    DependsOn:
      - CodedeployApplicationApi
      - ApiEC2
  CodeDeployRolePolicies:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: !Sub '${URI}-CodeDeployPolicy'
      PolicyDocument:
        Statement:
          - Effect: Allow
            Resource:
              - '*'
            Action:
              - 'ec2:Describe*'
          - Effect: Allow
            Resource:
              - '*'
            Action:
              - 'autoscaling:CompleteLifecycleAction'
              - 'autoscaling:DeleteLifecycleHook'
              - 'autoscaling:DescribeLifecycleHooks'
              - 'autoscaling:DescribeAutoScalingGroups'
              - 'autoscaling:PutLifecycleHook'
              - 'autoscaling:RecordLifecycleActionHeartbeat'
      Roles:
        - !Ref CodeDeployTrustRole
  InstanceRole:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - ec2.amazonaws.com
              AWS:
                - !Ref 'AWS::AccountId'
            Action:
              - 'sts:AssumeRole'
      ManagedPolicyArns:
        - 'arn:aws:iam::aws:policy/CloudWatchAgentServerPolicy'
        - 'arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore'
      Path: /
  InstanceRolePolicies:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: !Sub '${URI}-InstanceRolePolicy'
      PolicyDocument:
        Statement:
          - Effect: Allow
            Action:
              - ses:SendEmail
              - s3:PutObject
              - autoscaling:Describe*
              - sts:AssumeRole
              - logs:Create*
              - cloudformation:GetTemplate
              - ses:SendRawEmail
              - s3:Get*
              - s3:DeleteObject
              - logs:PutLogEvents
              - cloudformation:Describe*
              - secretsmanager:GetSecretValue
              - ec2:AcceptVpcPeeringConnection
              - ec2:CreateRoute
              - ec2:DescribeVpcPeeringConnections
            Resource: '*'
      Roles:
        - !Ref InstanceRole
  InstanceRoleInstanceProfile:
    Type: 'AWS::IAM::InstanceProfile'
    Properties:
      Path: /
      Roles:
        - !Ref InstanceRole
  VPC:
    Type: 'AWS::EC2::VPC'
    Properties:
      EnableDnsSupport: true
      EnableDnsHostnames: true
      CidrBlock: !FindInMap
        - Environments
        - !Ref env
        - VpcCIDRBlock
      Tags:
        - Key: Name
          Value: !Sub '${URI}-VPC'
  PublicSubnet:
    Type: 'AWS::EC2::Subnet'
    Properties:
      AvailabilityZone: !Select
        - 0
        - !GetAZs
          Ref: 'AWS::Region'
      VpcId: !Ref VPC
      CidrBlock: !FindInMap
        - Environments
        - !Ref env
        - PublicSubnetCIDR
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${URI}-public-subnet'
  InternetGateway:
    Type: 'AWS::EC2::InternetGateway'
  GatewayAttachment:
    Type: 'AWS::EC2::VPCGatewayAttachment'
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC
  PublicRouteTable:
    Type: 'AWS::EC2::RouteTable'
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${URI}-public-route-table'
      VpcId: !Ref VPC
  PublicRoute:
    Type: 'AWS::EC2::Route'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
    DependsOn:
      - GatewayAttachment
  PublicSubnetRouteTableAssociation:
    Type: 'AWS::EC2::SubnetRouteTableAssociation'
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet
  RecordSetGroup:
    Type: 'AWS::Route53::RecordSetGroup'
    Properties:
      HostedZoneId: !Ref HostedZoneId
      RecordSets:
        - AliasTarget:
            DNSName: !GetAtt
              - ApiDistribution
              - DomainName
            EvaluateTargetHealth: 'false'
            HostedZoneId: Z2FDTNDATAQYW2
          Name: !Ref ApiUrl
          Type: A
  AtlasNetworkPeering:
    Type: 'MongoDB::Atlas::NetworkPeering'
    Properties:
      ProjectId: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:ProjectId}}'
      ApiKeys:
        PublicKey: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:PublicKey}}'
        PrivateKey: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:PrivateKey}}'
      AccepterRegionName: !Ref ClusterRegion
      AwsAccountId: !Sub '${AWS::AccountId}'
      RouteTableCIDRBlock: !FindInMap
        - Environments
        - !Ref env
        - VpcCIDRBlock
      VpcId: !Ref VPC
  # AtlasCluster:
  #   Type: 'MongoDB::Atlas::Cluster'
  #   Properties:
  #     ProjectId: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:ProjectId}}'
  #     ApiKeys:
  #       PublicKey: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:PublicKey}}'
  #       PrivateKey: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:PrivateKey}}'
  #     Name: !Ref ClusterName
  #     MongoDBMajorVersion: !Ref ClusterMongoDBMajorVersion
  #     ReplicationFactor: 3
  #     NumShards: 1
  #     ProviderSettings:
  #       ProviderName: AWS
  #       InstanceSizeName: !FindInMap
  #         - Environments
  #         - !Ref env
  #         - ClusterInstanceSize
  #       RegionName: !Ref 'AWS::Region'
  AtlasDatabaseUser:
    Type: 'MongoDB::Atlas::DatabaseUser'
    # DependsOn: AtlasCluster
    Properties:
      ProjectId: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:ProjectId}}'
      ApiKeys:
        PublicKey: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:PublicKey}}'
        PrivateKey: !Sub '{{resolve:secretsmanager:${AwsSecretName}:SecretString:PrivateKey}}'
      Username: !GetAtt
        - InstanceRole
        - Arn
      DatabaseName: $external
      AWSIAMType: ROLE
      Roles:
        - RoleName: readWrite
          DatabaseName: !Ref DatabaseName
Outputs:
  VpcId:
    Value: !Ref VPC
  PublicRouteTableId:
    Value: !Ref PublicRouteTable
  DatabaseUser:
    Value: !GetAtt
      - InstanceRole
      - Arn
  AtlasSrvAddress:
    Value: !Ref DatabaseSrv
